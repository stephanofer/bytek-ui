---
/**
 * LanguageSelector â€” Dropdown for switching site language (i18n-aware)
 *
 * UX improvements over previous version:
 * - Actually navigates to the equivalent page in the other language
 * - Shows current language with visual indicator
 * - Uses <a> tags instead of buttons (real navigation, not JS-dependent)
 * - Hover on non-selected option shows "Switch to X" tooltip via title
 * - Clean, minimal design matching the header
 */
import { getIcon } from "@lib/icons";
import { getLangFromUrl, useTranslations, getLocalizedPath, languages } from "@/i18n/utils";
import Global from "@/assets/icons/global.svg";

interface Props {
  class?: string;
}

const { class: className = "" } = Astro.props;

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const currentPath = Astro.url.pathname;

// Build language options with their target URLs
const langOptions = Object.entries(languages).map(([code, fullLabel]) => ({
  code,
  label: code.toUpperCase(),
  fullLabel,
  href: getLocalizedPath(currentPath, code as keyof typeof languages),
  isCurrent: code === lang,
}));
---

<div class:list={["relative", className]} data-language-selector>
  <button
    type="button"
    class="flex items-center gap-1.5 p-2 rounded-lg text-neutral-600 hover:text-neutral-900 hover:bg-neutral-100 transition-colors duration-200 cursor-pointer"
    aria-expanded="false"
    aria-haspopup="listbox"
    aria-label={t("a11y.lang.select")}
    data-lang-trigger
  >
    <span class="w-5 h-5" aria-hidden="true">
      <Global width={20} height={20} />
    </span>
    <span class="text-sm font-medium uppercase" data-lang-current>
      {lang}
    </span>
    <span class="w-3.5 h-3.5 transition-transform duration-200" aria-hidden="true" data-lang-chevron>
      <Fragment set:html={getIcon("chevron-down")} />
    </span>
  </button>

  <!-- Dropdown -->
  <div
    class="absolute right-0 top-full mt-1.5 min-w-[160px] bg-white rounded-xl border border-neutral-200 shadow-lg shadow-neutral-900/5 opacity-0 invisible translate-y-1 transition-all duration-200 ease-(--ease-snappy) z-50"
    role="listbox"
    aria-label={t("a11y.lang.available")}
    data-lang-dropdown
  >
    <div class="p-1.5">
      {langOptions.map((option) => (
        <a
          href={option.href}
          role="option"
          aria-selected={option.isCurrent ? "true" : "false"}
          title={option.isCurrent ? option.fullLabel : `${t("lang.switch-to")} ${option.fullLabel}`}
          class:list={[
            "flex items-center gap-3 w-full px-3 py-2.5 rounded-lg text-sm transition-colors duration-150 no-underline",
            option.isCurrent
              ? "bg-primary-50 text-primary-700 font-medium cursor-default"
              : "text-neutral-600 hover:bg-neutral-50 hover:text-neutral-900",
          ]}
          data-lang-option={option.code}
        >
          <span class="font-medium uppercase text-xs tracking-wide w-6">
            {option.label}
          </span>
          <span class="flex-1">{option.fullLabel}</span>
          {option.isCurrent && (
            <span class="text-primary-500 shrink-0">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4">
                <path d="M20 6 9 17l-5-5" />
              </svg>
            </span>
          )}
        </a>
      ))}
    </div>
  </div>
</div>

<script>
  function initLanguageSelectors() {
    const selectors = document.querySelectorAll<HTMLDivElement>("[data-language-selector]");

    selectors.forEach((selector) => {
      const trigger = selector.querySelector<HTMLButtonElement>("[data-lang-trigger]");
      const dropdown = selector.querySelector<HTMLDivElement>("[data-lang-dropdown]");
      const chevron = selector.querySelector<HTMLSpanElement>("[data-lang-chevron]");

      if (!trigger || !dropdown || !chevron) return;

      let isOpen = false;

      function toggle() {
        isOpen = !isOpen;
        trigger!.setAttribute("aria-expanded", String(isOpen));

        if (isOpen) {
          dropdown!.classList.remove("opacity-0", "invisible", "translate-y-1");
          dropdown!.classList.add("opacity-100", "visible", "translate-y-0");
          chevron!.classList.add("rotate-180");
        } else {
          dropdown!.classList.add("opacity-0", "invisible", "translate-y-1");
          dropdown!.classList.remove("opacity-100", "visible", "translate-y-0");
          chevron!.classList.remove("rotate-180");
        }
      }

      function close() {
        if (!isOpen) return;
        isOpen = false;
        trigger!.setAttribute("aria-expanded", "false");
        dropdown!.classList.add("opacity-0", "invisible", "translate-y-1");
        dropdown!.classList.remove("opacity-100", "visible", "translate-y-0");
        chevron!.classList.remove("rotate-180");
      }

      trigger.addEventListener("click", (e) => {
        e.stopPropagation();
        toggle();
      });

      // Close on click outside
      document.addEventListener("click", (e) => {
        if (!selector.contains(e.target as Node)) {
          close();
        }
      });

      // Close on Escape
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") close();
      });
    });
  }

  // Run on initial load
  initLanguageSelectors();

  // Re-run after Astro page transitions (View Transitions)
  document.addEventListener("astro:after-swap", initLanguageSelectors);
</script>
