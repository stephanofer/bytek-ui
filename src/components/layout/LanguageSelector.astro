---
/**
 * LanguageSelector — Dropdown for switching site language
 *
 * Renders a globe icon with a dropdown to pick between ES/EN.
 * Uses vanilla JS for the toggle (no framework needed for this).
 * Styled to match the header design — minimal, clean, accessible.
 */
import { getIcon } from "@lib/icons";
import { SITE } from "@lib/constants";
import Global from '@/assets/icons/global.svg';


interface Props {
  class?: string;
}

const { class: className = "" } = Astro.props;

const currentLang = SITE.defaultLanguage;
const languages = [
  { code: "es", label: "ES", fullLabel: "Español" },
  { code: "en", label: "EN", fullLabel: "English" },
];
---

<div class:list={["relative", className]} data-language-selector>
  <button
    type="button"
    class="flex items-center gap-1.5 p-2 rounded-lg text-neutral-600 hover:text-neutral-900 hover:bg-neutral-100 transition-colors duration-200 cursor-pointer"
    aria-expanded="false"
    aria-haspopup="listbox"
    aria-label="Seleccionar idioma"
    data-lang-trigger
  >
    <span class="w-5 h-5" aria-hidden="true">
      <Global width={20} height={20}/>
    </span>
    <span class="text-sm font-medium uppercase" data-lang-current>
      {currentLang}
    </span>
    <span class="w-3.5 h-3.5 transition-transform duration-200" aria-hidden="true" data-lang-chevron>
      <Fragment set:html={getIcon("chevron-down")} />
    </span>
  </button>

  <!-- Dropdown -->
  <div
    class="absolute right-0 top-full mt-1.5 min-w-[140px] bg-white rounded-xl border border-neutral-200 shadow-lg shadow-neutral-900/5 opacity-0 invisible translate-y-1 transition-all duration-200 ease-(--ease-snappy) z-50"
    role="listbox"
    aria-label="Idiomas disponibles"
    data-lang-dropdown
  >
    <div class="p-1.5">
      {languages.map((lang) => (
        <button
          type="button"
          role="option"
          aria-selected={lang.code === currentLang}
          class:list={[
            "flex items-center gap-3 w-full px-3 py-2 rounded-lg text-sm transition-colors duration-150 cursor-pointer",
            lang.code === currentLang
              ? "bg-neutral-100 text-neutral-900 font-medium"
              : "text-neutral-600 hover:bg-neutral-50 hover:text-neutral-900",
          ]}
          data-lang-option={lang.code}
        >
          <span class="font-medium uppercase text-xs tracking-wide w-6">
            {lang.label}
          </span>
          <span>{lang.fullLabel}</span>
          {lang.code === currentLang && (
            <span class="ml-auto text-primary-500">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4">
                <path d="M20 6 9 17l-5-5" />
              </svg>
            </span>
          )}
        </button>
      ))}
    </div>
  </div>
</div>

<script>
  function initLanguageSelectors() {
    const selectors = document.querySelectorAll<HTMLDivElement>("[data-language-selector]");

    selectors.forEach((selector) => {
      const trigger = selector.querySelector<HTMLButtonElement>("[data-lang-trigger]");
      const dropdown = selector.querySelector<HTMLDivElement>("[data-lang-dropdown]");
      const chevron = selector.querySelector<HTMLSpanElement>("[data-lang-chevron]");

      if (!trigger || !dropdown || !chevron) return;

      let isOpen = false;

      function toggle() {
        isOpen = !isOpen;
        trigger!.setAttribute("aria-expanded", String(isOpen));

        if (isOpen) {
          dropdown!.classList.remove("opacity-0", "invisible", "translate-y-1");
          dropdown!.classList.add("opacity-100", "visible", "translate-y-0");
          chevron!.classList.add("rotate-180");
        } else {
          dropdown!.classList.add("opacity-0", "invisible", "translate-y-1");
          dropdown!.classList.remove("opacity-100", "visible", "translate-y-0");
          chevron!.classList.remove("rotate-180");
        }
      }

      function close() {
        if (!isOpen) return;
        isOpen = false;
        trigger!.setAttribute("aria-expanded", "false");
        dropdown!.classList.add("opacity-0", "invisible", "translate-y-1");
        dropdown!.classList.remove("opacity-100", "visible", "translate-y-0");
        chevron!.classList.remove("rotate-180");
      }

      trigger.addEventListener("click", (e) => {
        e.stopPropagation();
        toggle();
      });

      // Close on click outside
      document.addEventListener("click", (e) => {
        if (!selector.contains(e.target as Node)) {
          close();
        }
      });

      // Close on Escape
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") close();
      });

      // Handle language option click
      const options = selector.querySelectorAll<HTMLButtonElement>("[data-lang-option]");
      options.forEach((option) => {
        option.addEventListener("click", () => {
          const langCode = option.dataset.langOption;
          // For now, just log - i18n routing will be implemented later
          console.log(`Language selected: ${langCode}`);
          close();
        });
      });
    });
  }

  // Run on initial load
  initLanguageSelectors();

  // Re-run after Astro page transitions (View Transitions)
  document.addEventListener("astro:after-swap", initLanguageSelectors);
</script>
